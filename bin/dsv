#!/usr/bin/env node
const CLApp = require('app-term-kit');
const div = require('../divisive.js');
const fs = require('fs');


let app = new CLApp('divisive', {
    copyright : 'Abbey Hawk Sparrow',
    copystart : '2022',
    defaults : `{
  // This file was autogenerated by divisive
  //
  "debug": false
}`
});

app.command({
    name : 'parse',
    description: 'parse a given CSV into JSON',
    examples : [
        [
            '$0 parse datafile.csv',
            'parse all rows/columns from the file `datafile.csv`'
        ]
    ],
    action : function(argv, target, complete){
        console.log('[');
        let filter = null;
        if(argv.filter) try{
            filter = JSON.parse(argv.filter)
        }catch(ex){ }
        let seen = false;
        div.parseData(target, {
            filter: filter,
            row : (item)=>{
                if(!seen) console.log( '    ' +JSON.stringify(item).replace(/\\"/g, '\\"'));
                else console.log( '    ,' +JSON.stringify(item));
                if(!seen) seen = true;
            }
        }, (err, result)=>{
            console.log("\n"+']');
        });
    }
});

app.argument('filter', 'string', 'MongoQueryDocument filter', 1);

app.header();
app.footer();
app.help();
app.run((err)=>{
    if(err) console.log(err);
});
